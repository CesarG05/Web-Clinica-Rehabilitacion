<div class="servicios-container">

  <app-back-header titulo="Lista de servicios"></app-back-header>


  <!-- Buscador y botón -->
  <div class="top-bar">
    <app-input-field
      type="text"
      label="Buscar servicios"
      [iconPath]="'M10 2a8 8 0 1 0 5.29 14.29l4.15 4.15l1.41-1.41l-4.15-4.15A8 8 0 0 0 10 2m0 2a6 6 0 1 1 0 12A6 6 0 0 1 10 4Z'"
      [(model)]="searchText"
      (search)="buscar($event)"
    ></app-input-field>

    <button class="btn-agregar" routerLink="nuevo-servicio">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 21q-.425 0-.712-.288T11 20v-7H4q-.425 0-.712-.288T3 12t.288-.712T4 11h7V4q0-.425.288-.712T12 3t.713.288T13 4v7h7q.425 0 .713.288T21 12t-.288.713T20 13h-7v7q0 .425-.288.713T12 21" />
      </svg>
      <span>Nuevo servicio</span>
    </button>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <div class="buttons">
      <button [class.active]="disponibleFilter === true" (click)="cambiarFiltro(true)">Disponibles</button>
      <button [class.active]="disponibleFilter === false" (click)="cambiarFiltro(false)">No disponibles</button>
      <button  [class.active]="disponibleFilter === null" (click)="cambiarFiltro(null)">Todos</button>
    </div>

    @if(!cargando){
         <p class="total">Total: {{ totalServicios }}</p>
    }
  </div>

  <!-- Titulo y agregar categoría -->
    <div class="categorias-header">
        <h3 class="titulo-categoria" (click)="abrirModalListaCategorias()">
            Categorías
        </h3>

        <button class="btn-text" (click)="abrirModalAddCategoria()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 21q-.425 0-.712-.288T11 20v-7H4q-.425 0-.712-.288T3 12t.288-.712T4 11h7V4q0-.425.288-.712T12 3t.713.288T13 4v7h7q.425 0 .713.288T21 12t-.288.713T20 13h-7v7q0 .425-.288.713T12 21" />
            </svg>
             Agregar categoría
        </button>
    </div>
  
  @if (cargando) {
    <div class="loader">
      <img src="assets/loaders/circles.svg" alt="Cargando..." />
      <p>Cargando servicios...</p>
    </div>
  }

  @if (!cargando && grupos().length === 0) {
    <div class="no-results">
      <p>No hay servicios encontrados</p>
    </div>
  }

  <!-- Lista de servicios -->
    @if (!cargando) {

    <div class="lista-grupos">

        @for (g of grupos(); track g.categoria) {

        <div class="grupo">

            <!-- Titulo Categoria -->
            <div class="categoria-header" (click)="toggleCategoria(g.categoria)">
            <div class="left">
                <span class="arrow" [class.expanded]="expanded()[g.categoria]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12 14.975q-.2 0-.375-.062T11.3 14.7l-4.6-4.6q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l3.9 3.9l3.9-3.9q.275-.275.7-.275t.7.275t.275.7t-.275.7l-4.6 4.6q-.15.15-.325.213t-.375.062" />
                    </svg>
                </span>
                <h3>{{ g.categoria }}</h3>
            </div>
            <span class="count">{{ g.servicios.length }}</span>
            </div>

            <!-- Lista de servivios por categoria -->
            @if (expanded()[g.categoria]) {

            <div class="categoria-body">

                @for (servicio of g.servicios; track servicio.id) {

                <div class="servicio-card">

                    <div class="info">
                        <h4>{{ servicio.nombre }}</h4>
                        <p class="descripcion">{{ servicio.descripcion }}</p>

                        <div class="tags">
                            <span class="tag costo">
                                <svg  class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <g fill="none" fill-rule="evenodd">
                                        <path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z" />
                                        <path fill="currentColor" d="M20 5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zM4.125 14L4 14.003v2.006a.875.875 0 0 1 1 .866l-.002.063L4.99 17h2.006L7 16.875A2.875 2.875 0 0 0 4.125 14m15.75 0a2.875 2.875 0 0 0-2.87 2.706l-.005.169q0 .063.003.125h2.006a.875.875 0 0 1 .991-.991v-2.006zM12 8a4 4 0 1 0 0 8a4 4 0 0 0 0-8m0 2a2 2 0 1 1 0 4a2 2 0 0 1 0-4M7 7H5v.125a.875.875 0 0 1-1 .866v2.006l.125.003A2.875 2.875 0 0 0 7 7.125zm12.009 0h-2.006L17 7.125a2.875 2.875 0 0 0 2.706 2.87l.232.004l.062-.002V7.991a.875.875 0 0 1-1-.866l.002-.063z" />
                                    </g>
                                </svg>
                                $ {{ servicio.costo }} MXN
                            </span>

                            <span class="tag duracion">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M12 1a11 11 0 1 0 11 11A11 11 0 0 0 12 1zm1 11h5v2h-7V6h2z"/>
                                </svg>
                                 {{ convertirDuracionAMinutos(servicio.duracionEstimada) }} min
                            </span>

                            <span class="tag estado" [class.off]="!servicio.disponible">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                        d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 14h-2v-2h2zm0-4h-2V6h2z" />
                                </svg>
                                {{ servicio.disponible ? 'Disponible' : 'No disponible' }}
                            </span>
                        </div>

                    </div>

                    <button class="menu-btn" (click)="toggleMenu(servicio.id, $event)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="3.75" d="M12 12h.01v.01H12zm0-7h.01v.01H12zm0 14h.01v.01H12z" />
                        </svg>
                    </button>

                    <!-- Menu -->
                    @if (menuAbiertoId() === servicio.id) {
                    <div class="menu-dropdown">
                        <button (click)="router.navigate(['/servicios/editar', servicio.id])">Editar</button>

                        <button (click)="cambiarDisponibilidad(servicio)">
                        {{ servicio.disponible ? 'Cambiar a no disponible' : 'Cambiar a disponible' }}
                        </button>

                        <button class="delete" (click)="eliminarServicio(servicio)">
                          Eliminar
                        </button>
                    </div>
                    }
                </div>
                @if (g.servicios.indexOf(servicio) < g.servicios.length - 1) {
                    <hr class="division">
                }

                }
            </div>
            }
        </div>
        }
    </div>
    }

</div>

@if (modalAbierto) {
  <app-confirm-modal
    [title]="modalTitle"
    [message]="modalMessage"
    (confirm)="modalConfirmCallback && modalConfirmCallback(); cerrarModal()"
    (cancel)="cerrarModal()">
  </app-confirm-modal>
}

<!-- Modal add categoria -->
@if (mostrarModalAddCategoria) {
  <app-add-category-modal 
      (save)="guardarCategoria($event)"
      (cancel)="cerrarModalAddCategoria()">
  </app-add-category-modal>
}

<!-- Modal lista categorias -->
<!-- Modal lista categorias -->
@if (mostrarModalCategorias) {
<div class="modal-backdrop">
  <div class="modal-contenido">
    
    <div class="modal-header">
      <h2>Categorías</h2>
      <button class="btn-cerrar-x" (click)="cerrarModalCategorias()">✕</button>
    </div>

    <ul class="lista-categorias">
      @for (cat of categorias; track cat.id) {
        <li>
          <span>{{ cat.nombre }}</span>

          <button class="btn-eliminar" (click)="cat.id && eliminarCategoria(cat.id)">
            Eliminar
          </button>
        </li>
      }
    </ul>

    <button class="btn-cerrar" (click)="cerrarModalCategorias()">Cerrar</button>

  </div>
</div>
}