<div class="sesion-create-container">

  <app-back-header titulo="Registrar nueva sesión"></app-back-header>

  <div class="content-sesion-nueva">

    <!-- COLUMNA IZQUIERDA -->
    <section class="col-izquierda">
      <!--  Paciente -->
      <section class="card card-paciente">

        <div class="card-tittle">
          <h3>Seleccione al paciente</h3>

          @if (sesion.pacienteId) {
            <button class="btn-reset" (click)="resetPaciente()" title="Deseleccionar paciente">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20">
                <path fill="currentColor" d="M12 20q-3.35 0-5.675-2.325T4 12t2.325-5.675T12 4q1.725 0 3.3.712T18 6.75V5q0-.425.288-.712T19 4t.713.288T20 5v5q0 .425-.288.713T19 11h-5q-.425 0-.712-.288T13 10t.288-.712T14 9h3.2q-.8-1.4-2.187-2.2T12 6Q9.5 6 7.75 7.75T6 12t1.75 4.25T12 18q1.7 0 3.113-.862t2.187-2.313q.2-.35.563-.487t.737-.013q.4.125.575.525t-.025.75q-1.025 2-2.925 3.2T12 20" />
              </svg>
            </button>
          }
        </div>

        <div class="input-wrapper">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path fill="currentColor" d="M9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l5.6 5.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275l-5.6-5.6q-.75.6-1.725.95T9.5 16m0-2q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14" />
          </svg>
          </span>
          <input
            type="text"
            placeholder="Buscar paciente..."
            [(ngModel)]="searchPaciente"
            (ngModelChange)="filtrarPacientes()"
          />
        </div>

         @if (pacientes.length === 0) {
          <p class="empty">
            No hay paceintes registrados
          </p>
        } @else {
          <ul class="list scrollable-list">
            @for (p of pacientesFiltrados; track p.id) {
              <li
                class="item"
                (click)="seleccionarPaciente(p)"
                [class.selected]="sesion.pacienteId === p.id"
              >
              @if (sesion.pacienteId === p.id) {
                <span class="check">✓</span>
              }
                {{ p.primerNombre }} {{ p.segundoNombre }}
                {{ p.primerApellido }} {{ p.segundoApellido }}
              </li>
            }
          </ul>
        }
      </section>

      <!-- Tratamiento -->
      <section class="card card-tratamiento">
        <div class="card-tittle">
            <h3>Seleccione el tratamiento</h3>
            @if (sesion.tratamientoId) {
              <button class="btn-reset" (click)="resetTratamiento()" title="Deseleccionar tratamiento">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20">
                  <path fill="currentColor" d="M12 20q-3.35 0-5.675-2.325T4 12t2.325-5.675T12 4q1.725 0 3.3.712T18 6.75V5q0-.425.288-.712T19 4t.713.288T20 5v5q0 .425-.288.713T19 11h-5q-.425 0-.712-.288T13 10t.288-.712T14 9h3.2q-.8-1.4-2.187-2.2T12 6Q9.5 6 7.75 7.75T6 12t1.75 4.25T12 18q1.7 0 3.113-.862t2.187-2.313q.2-.35.563-.487t.737-.013q.4.125.575.525t-.025.75q-1.025 2-2.925 3.2T12 20" />
                </svg>
              </button>
            }
        </div>
        
        @if (!sesion.pacienteId) {
          <p class="empty">
            Seleccione un paciente para ver sus tratamientos
          </p>
        }
        @else if (totalTratamientos === 0) {
          <p class="empty">
            El paciente no tiene tratamientos registrados
          </p>
        }
        @else if (tratamientos.length === 0) {
          <p class="empty">
            El paciente no cuenta con tratamientos en curso
          </p>
        }
        @else {
          <ul class="list scrollable-list">
            @for (t of tratamientos; track t.tratamientoId) {
              <li
                class="item tratamiento-item"
                (click)="seleccionarTratamiento(t)"
                [class.selected]="sesion.tratamientoId === t.tratamientoId"
              >
                @if (sesion.tratamientoId === t.tratamientoId) {
                  <span class="check">✓</span>
                }
                <div class="tratamiento-info">
                  <p class="padecimiento">{{ t.padecimiento }}</p>
                  <p class="tratamiento">{{ t.tratamiento }}</p>
                </div>
              </li>
            }
          </ul>
        }
      </section>

    </section>

    <!-- COLUMNA DERECHA -->
    <section class="col-derecha">
      <!-- Servicio -->
      <section class="card card-servicio">
        <div class="card-tittle">
            <h3>Seleccione el servicio</h3>
            @if (sesion.servicioId) {
              <button class="btn-reset" (click)="resetServicio()" title="Deseleccionar servicio">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20">
                  <path fill="currentColor" d="M12 20q-3.35 0-5.675-2.325T4 12t2.325-5.675T12 4q1.725 0 3.3.712T18 6.75V5q0-.425.288-.712T19 4t.713.288T20 5v5q0 .425-.288.713T19 11h-5q-.425 0-.712-.288T13 10t.288-.712T14 9h3.2q-.8-1.4-2.187-2.2T12 6Q9.5 6 7.75 7.75T6 12t1.75 4.25T12 18q1.7 0 3.113-.862t2.187-2.313q.2-.35.563-.487t.737-.013q.4.125.575.525t-.025.75q-1.025 2-2.925 3.2T12 20" />
                </svg>
              </button>
            }
        </div>
    
        <div class="input-wrapper">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <path fill="currentColor" d="M9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l5.6 5.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275l-5.6-5.6q-.75.6-1.725.95T9.5 16m0-2q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14" />
            </svg>
          </span>
          <input
            type="text"
            placeholder="Buscar servicio..."
            [(ngModel)]="searchService"
            (ngModelChange)="filtrarServicios()"
          />
        </div>

        @if (serviciosFiltrados.length === 0) {
          <p class="empty">
            No hay servicios registrados o disponibles
          </p>
        } @else {
          <div class="scrollable-list servicios-scroll">
            @for (grupo of serviciosFiltrados; track grupo.categoria) {
              <h4 class="categoria">{{ grupo.categoria }}</h4>

              <ul class="list">
                @for (s of grupo.servicios; track s.id) {
                  <li
                    class="item"
                    (click)="seleccionarServicio(s)"
                    [class.selected]="sesion.servicioId === s.id"
                  >
                    @if (sesion.servicioId === s.id) {
                      <span class="check">✓</span>
                    }
                    {{ s.nombre }} - {{ s.duracionEstimada }}
                  </li>
                }
              </ul>
            }
          </div>
        }

      </section>

      <!--  Botón  -->
      <button
        class="btn-save"
        (click)="guardarSesion()"
        [disabled]="
          cargando ||
          !sesion.pacienteId ||
          !sesion.servicioId
        "
      >
        Guardar sesión
      </button>
    </section>

  </div>
</div>